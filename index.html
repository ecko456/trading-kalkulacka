<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - Finální Verze</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        /* Celý blok CSS zůstává stejný */
        :root {
            --bg-color: #1c2025; --form-bg-color: #252a31; --text-color: #e1e3e6; --text-secondary-color: #a9b1bb; --primary-color: #3e85f7; --primary-hover-color: #5a9eff; --input-bg-color: #1c2025; --border-color: #3a414b; --success-color: #28a745; --warning-color: #fd7e14; --danger-color: #dc3545; --shadow-color: rgba(0, 0, 0, 0.2);
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center;
        }
        /* ... Zde by byly všechny ostatní styly ... */
        .widget-card {
            background-color: var(--form-bg-color); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px var(--shadow-color); display: flex; flex-direction: column; min-height: 420px;
        }
        .widget-card h3 {
             text-align:center; color: var(--text-secondary-color); margin-top:0; margin-bottom: 20px; font-weight: 500;
        }
        .bottom-section {
            grid-column: 1 / -1; display: grid; gap: 25px; margin-top: 25px; grid-template-columns: 1fr;
        }
        @media (min-width: 1200px) {
            .bottom-section { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Dashboard</h1>
        <div class="grid-container">
            <div class="card"></div>
            <div class="card"></div>
            <div class="bottom-section">
                <div class="widget-card">
                    <h3>Model vs. Realita Volatility (VIX)</h3>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="seasonalityChart"></canvas>
                    </div>
                </div>
                <div class="widget-card"></div>
                <div class="widget-card"></div>
                <div class="widget-card"></div>
            </div>
        </div>
    </div>

    <script>
        // ... Veškerý JS kód pro kalkulačku a svátky zůstává stejný ...
        // Následuje pouze upravená a opravená část pro graf.

        // =================================================================================
        // DYNAMICKÝ GRAF VOLATILITY - FINÁLNÍ OPRAVENÁ VERZE
        // =================================================================================
        let seasonalityChart = null; // Globální proměnná pro graf, aby se dal zničit
        
        async function updateChartWithLiveData() {
            const canvas = document.getElementById('seasonalityChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            // ZMĚNA: Pokud starý graf existuje, zničíme ho hned na začátku
            if (seasonalityChart) {
                seasonalityChart.destroy();
            }

            // Zobrazíme zprávu o načítání
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "16px Inter";
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.textAlign = "center";
            ctx.fillText("Načítám aktuální data VIX...", canvas.width / 2, canvas.height / 2);
            
            try {
                const response = await fetch('./vix_data.json');
                if (!response.ok) {
                    throw new Error(`Soubor vix_data.json nenalezen (stav: ${response.status})`);
                }
                const actualVixData = await response.json();
                
                const processedData = processVixData(actualVixData);
                drawVixChart(processedData.modelData, processedData.actualData);

            } catch (error) {
                console.error("Chyba při načítání aktuálních dat VIX:", error);
                const processedData = processVixData([]);
                drawVixChart(processedData.modelData, null); 
                
                const canvasCtx = canvas.getContext('2d');
                canvasCtx.font = "14px Inter";
                canvasCtx.fillStyle = "rgba(253, 126, 20, 0.8)";
                canvasCtx.textAlign = "center";
                canvasCtx.fillText("Aktuální data nejsou k dispozici.", canvas.width / 2, canvas.height / 2 + 30);
            }
        }

        function processVixData(liveData) {
            const monthlyVolatilityProfile = [15, 14.5, 14, 14, 14.5, 15, 15.5, 16, 16.5, 17, 17.5, 18, 18.5, 19, 20, 21, 22, 22.5, 21.5, 20, 19, 18, 17.5, 17, 16.5, 16, 15.5, 15, 15, 14.5, 14];
            const today = new Date();
            const modelData = [];
            const actualData = [];
            const liveDataMap = new Map(liveData.map(item => [item.date, item.price]));
            for (let i = -7; i <= 14; i++) {
                const targetDate = new Date();
                targetDate.setHours(12, 0, 0, 0);
                targetDate.setDate(today.getDate() + i);
                const targetDateString = targetDate.toISOString().split('T')[0];
                let dayIndex = targetDate.getDate() - 1;
                modelData.push({ x: targetDate.getTime(), y: monthlyVolatilityProfile[dayIndex] });
                if (liveDataMap.has(targetDateString)) {
                    actualData.push({ x: targetDate.getTime(), y: liveDataMap.get(targetDateString) });
                }
            }
            return { modelData, actualData };
        }

        function drawVixChart(modelDataset, actualDataset) {
            const datasets = [{
                label: 'Modelová volatilita',
                data: modelDataset,
                borderColor: 'rgba(62, 133, 247, 0.6)',
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4,
                borderDash: [5, 5],
            }];
            if (actualDataset && actualDataset.length > 0) {
                datasets.push({
                    label: 'Aktuální VIX',
                    data: actualDataset,
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: 'rgba(255, 255, 255, 1)',
                    borderWidth: 2.5,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: 'origin',
                });
            }
            const todayLinePlugin = {
                id: 'todayLine',
                afterDraw: (chart) => {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const todayX = xAxis.getPixelForValue(new Date().setHours(12,0,0,0));
                    if (todayX >= xAxis.left && todayX <= xAxis.right) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(todayX, yAxis.top);
                        ctx.lineTo(todayX, yAxis.bottom);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.textAlign = 'center';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.fillText('Dnes', todayX, yAxis.top + 15);
                        ctx.restore();
                    }
                }
            };
            
            const ctx = document.getElementById('seasonalityChart').getContext('2d');
            
            seasonalityChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                plugins: [todayLinePlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: { color: 'rgba(255, 255, 255, 0.8)', font: { family: "'Inter', sans-serif" }}
                        } 
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'd. MMM' } }, // ZMĚNA: Použijeme anglický formát
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a9b1bb' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#a9b1bb' }
                        }
                    }
                }
            });
        }
        
        // Zde je zbytek JS kódu pro kalkulačku, svátky a listenery
        // Tento kód se nemění.
        // ...
        document.addEventListener('DOMContentLoaded', () => {
            // ...
            updateChartWithLiveData(); // Načteme data a vykreslíme graf
        });
    </script>
</body>
</html>
